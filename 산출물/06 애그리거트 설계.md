# 1. 애그리거트 후보 식별
- 대여 컨텍스트
    - Loan 애그리거트 (대여 + 연장)
    - Reservation 애그리거트 (예약)
- 카탈로그 컨텍스트
    - Book 애그리거트 (도서 정보)
    - Review 애그리거트 (리뷰)
- 회원 컨텍스트
    - Member 애그리거트 (회원 정보)
- 알림 컨텍스트
    - Notification 애그리거트 (알림)
- 인증 컨텍스트
    - User 애그리거트 (사용자 인증)


# 2. 애그리거트 설계
## 2.1. Loan 애그리거트
1. LoanStatus (VO)
```java
enum LoanStatus {
    AVAILABLE,      // 대여 가능 (초기 상태 - 도서 관점)
    ON_LOAN,        // 대여 중 
    PROCESSING,     // 정리중 (반납되어 관리자가 정리중)
    LOAN_WAITING,   // 대여 대기 (예약 순서가 와서 3일간 우선권)
    OVERDUE,        // 연체됨
    DAMAGED         // 파손됨
}
```

2. LoanPeriod (VO)
```java
class LoanPeriod {
    private final LocalDate startDate;
    private final LocalDate dueDate;
    
    public static LoanPeriod standardPeriod() {
        LocalDate now = LocalDate.now();
        return new LoanPeriod(now, now.plusDays(7));
    }
    
    public LoanPeriod extend(int days) {
        return new LoanPeriod(startDate, dueDate.plusDays(days));
    }
    
    public boolean isOverdue() {
        return LocalDate.now().isAfter(dueDate);
    }
    
    public int getOverdueDays() {
        if (!isOverdue()) return 0;
        return (int) ChronoUnit.DAYS.between(dueDate, LocalDate.now());
    }
    
    // 연장 이력 관리를 위한 메서드 ✨
    public LocalDate getDueDate() {
        return dueDate;
    }
}
```

3. LoanExtension (VO)
```java
class LoanExtension {
    private ExtensionId id;
    private String reason;
    private LocalDateTime requestedAt;   // 연장 요청일 ✨ 추가
    private LocalDate newDueDate;       // 연장 후 반납예정일 ✨ 추가
    private int extendedDays;           // 연장 일수 (기본 3일)
    
    // 패키지 프라이빗 생성자
    LoanExtension(String reason, LocalDate currentDueDate) {
        this.id = ExtensionId.generate();
        this.reason = reason;
        this.requestedAt = LocalDateTime.now();
        this.extendedDays = 3;  // 기본 3일
        this.newDueDate = currentDueDate.plusDays(extendedDays);
    }
}
```

4. Loan (Entity)
```java
class Loan {
    // 식별자
    private LoanId id;
    
    // 외부 애그리거트 참조 (ID만)
    private MemberId memberId;
    private ISBN bookIsbn;
    
    // 값 객체들
    private LoanPeriod period;
    private LoanStatus status;
    
    // 날짜 정보
    private LocalDateTime borrowedAt;
    private LocalDateTime returnedAt;
    
    // 내부 엔티티
    private List<LoanExtension> extensions;
    
    // 기본 비즈니스 메서드들
    public void borrow() { ... }
    public void returnBook() { ... }
    public void extend(String reason) { ... }
    public boolean isOverdue() { ... }
    public Money calculatePenalty(Money bookPrice) { ... }
    
    // 상태 전환 메서드들
    public void completeReturn() { ... }
    public void assignToReservation() { ... }
    public void markAsDamaged() { ... }
    public void markAsOverdue() { ... }


    // 상태 전환 메서드들
    public void borrow() {
        // AVAILABLE → ON_LOAN
        if (this.status != LoanStatus.AVAILABLE) {
            throw new IllegalStateException("Book is not available for loan");
        }
        this.status = LoanStatus.ON_LOAN;
        // ... 기타 로직
    }
    
    public void returnBook() {
        // ON_LOAN → PROCESSING 또는 OVERDUE → PROCESSING
        if (this.status != LoanStatus.ON_LOAN && this.status != LoanStatus.OVERDUE) {
            throw new IllegalStateException("Cannot return book in current status");
        }
        this.status = LoanStatus.PROCESSING;
        this.returnedAt = LocalDateTime.now();
    }
    
    public void completeReturn() {
        // PROCESSING → AVAILABLE (관리자 확인 후)
        if (this.status != LoanStatus.PROCESSING) {
            throw new IllegalStateException("Book is not in processing status");
        }
        this.status = LoanStatus.AVAILABLE;
    }
    
    public void assignToReservation() {
        // PROCESSING → LOAN_WAITING (예약자가 있는 경우)
        if (this.status != LoanStatus.PROCESSING) {
            throw new IllegalStateException("Book is not in processing status");
        }
        this.status = LoanStatus.LOAN_WAITING;
    }
    
    public void markAsDamaged() {
        // PROCESSING → DAMAGED (파손 확인 시)
        if (this.status != LoanStatus.PROCESSING) {
            throw new IllegalStateException("Book is not in processing status");
        }
        this.status = LoanStatus.DAMAGED;
    }
    
    public void markAsOverdue() {
        // ON_LOAN → OVERDUE (시간 경과, 시스템 자동)
        if (this.status != LoanStatus.ON_LOAN) {
            throw new IllegalStateException("Only active loans can become overdue");
        }
        this.status = LoanStatus.OVERDUE;
    }


    public void extend(String reason) {
        if (this.status != LoanStatus.ACTIVE) {
            throw new IllegalStateException("Cannot extend non-active loan");
        }
        
        if (this.extensions.size() >= 2) {
            throw new MaxExtensionExceededException("Maximum 2 extensions allowed");
        }
        
        if (this.isOverdue()) {
            throw new CannotExtendOverdueLoanException("Cannot extend overdue loan");
        }
        
        // 연장 이력 추가
        LoanExtension extension = new LoanExtension(reason, this.period.getDueDate());
        this.extensions.add(extension);
        
        // 대여 기간 연장
        this.period = this.period.extend(3);
        
        // 도메인 이벤트 발행
        DomainEvents.raise(new LoanExtended(this.id, reason, extension.getNewDueDate()));
    }

    public Money calculatePenalty(Money bookPrice) {
        if (!isOverdue()) {
            return Money.ZERO;
        }
        
        int overdueDays = this.period.getOverdueDays();
        Money dailyPenalty = Money.of(100); // 하루당 100원
        Money totalPenalty = dailyPenalty.multiply(overdueDays);
        
        // 최대 연체료는 도서 가격까지
        return totalPenalty.min(bookPrice);
    }    
}
```


## 2.2. Reservation 애그리거트
- 루트: Reservation
- 값 객체: ReservationId, ReservationStatus, ReservationOrder
- 외부 참조: MemberId, ISBN (ID 참조)
- 주요 메서드: reserve(), cancel(), assignPriority()


## 2.3. Member 애그리거트  
- 루트: Member
- 값 객체: MemberId, MemberName, Contact, MemberStatus
- 주요 메서드: register(), suspend(), activate()


## 2.4. Book 애그리거트
- 루트: Book  
- 값 객체: ISBN, BookTitle, Author, Price, BookStatus
- 주요 메서드: register(), update(), markDamaged()

# 3. 패키지 구조
```
src/main/java/com/library/
├── shared/                    # 공통 요소
│   ├── domain/               # 공통 도메인
│   │   ├── vo/              # 공통 값 객체
│   │   │   ├── ISBN.java
│   │   │   ├── MemberId.java
│   │   │   ├── Money.java
│   │   │   └── Email.java
│   │   ├── event/           # 공통 도메인 이벤트
│   │   │   └── DomainEvent.java
│   │   └── exception/       # 공통 도메인 예외
│   │       └── DomainException.java
│   ├── application/         # 공통 애플리케이션
│   │   ├── config/         # 설정
│   │   │   ├── JpaConfig.java
│   │   │   └── EventConfig.java
│   │   └── event/          # 이벤트 처리
│   │       └── EventPublisher.java
│   └── infrastructure/      # 공통 인프라
│       ├── web/            # 웹 공통
│       │   ├── GlobalExceptionHandler.java
│       │   ├── ApiResponse.java
│       │   └── resolver/   # ArgumentResolver
│       ├── persistence/    # 영속성 공통
│       │   └── BaseEntity.java
│       └── security/       # 보안 공통
│           └── SecurityConfig.java
│
├── loan/                     # 대여 컨텍스트 🎯
│   ├── domain/              # 도메인 계층
│   │   ├── model/          # 도메인 모델
│   │   │   ├── Loan.java           # 애그리거트 루트
│   │   │   ├── LoanExtension.java  # 엔티티
│   │   │   ├── LoanId.java         # 식별자
│   │   │   ├── LoanStatus.java     # 열거형
│   │   │   └── LoanPeriod.java     # 값 객체
│   │   ├── service/        # 도메인 서비스
│   │   │   └── LoanDomainService.java
│   │   ├── repository/     # 리포지토리 인터페이스
│   │   │   └── LoanRepository.java
│   │   ├── event/          # 도메인 이벤트
│   │   │   ├── BookBorrowed.java
│   │   │   └── BookReturned.java
│   │   └── exception/      # 도메인 예외
│   │       ├── MaxExtensionExceededException.java
│   │       └── CannotExtendOverdueLoanException.java
│   ├── application/         # 애플리케이션 계층
│   │   ├── service/        # 애플리케이션 서비스
│   │   │   └── LoanApplicationService.java
│   │   ├── dto/            # DTO
│   │   │   ├── LoanRequest.java
│   │   │   └── LoanResponse.java
│   │   └── handler/        # 이벤트 핸들러
│   │       └── LoanEventHandler.java
│   ├── infrastructure/      # 인프라 계층
│   │   ├── persistence/    # 영속성
│   │   │   ├── LoanJpaRepository.java
│   │   │   ├── LoanRepositoryImpl.java
│   │   │   └── entity/
│   │   │       └── LoanJpaEntity.java
│   │   └── client/         # 외부 시스템 클라이언트
│   │       └── MemberClient.java
│   └── presentation/        # 프레젠테이션 계층
│       └── controller/
│           └── LoanController.java
│
├── member/                   # 회원 컨텍스트
│   ├── domain/
│   ├── application/
│   ├── infrastructure/
│   └── presentation/
│
├── catalog/                  # 카탈로그 컨텍스트
│   ├── domain/
│   ├── application/
│   ├── infrastructure/
│   └── presentation/
│
├── notification/             # 알림 컨텍스트
│   ├── domain/
│   ├── application/
│   ├── infrastructure/
│   └── presentation/
│
└── auth/                     # 인증 컨텍스트
    ├── domain/
    ├── application/
    ├── infrastructure/
    └── presentation/
```
